
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Node.js 概述 | 程序员的多肉花园</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="elevensky">
    
    <meta name="description" content="简介
Node.js是JavaScript在服务器端的一个运行环境，也是一个工具库，用来与服务器端其他软件互动。它的JavaScript解释器，采用了Google公司的V8引擎。
安装与更新
访问官方网站nodejs.org了解安装细节。
安装完成以后，运行下面的命令，查看是否能正常运行。
1234">
    
    
      <meta name="keywords" content="Web,前端,JavaScript,html5,css3">
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div style="position:relative;">
			
				<div class="line">
					<span></span>
					<div class="author"></div>
				</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="程序员的多肉花园">程序员的多肉花园</a></h1>
				<h2 class="blog-motto">hello world, hello 多肉</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:elevensky.github.io">
					</form>
					
					</li>
				</ul>
			</nav>
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/25/nodejs基础教程/" title="Node.js 概述" itemprop="url">Node.js 概述</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://elevensky.github.io" title="elevensky">elevensky</a>
    </p>
  <p class="article-time">
    <time datetime="2015-02-25T04:48:54.000Z" itemprop="datePublished">2月 25 2015</time>
    更新日期:<time datetime="2015-02-25T05:00:32.000Z" itemprop="dateModified">2月 25 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装与更新"><span class="toc-number">1.1.</span> <span class="toc-text">安装与更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#版本管理工具nvm"><span class="toc-number">1.2.</span> <span class="toc-text">版本管理工具nvm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本用法"><span class="toc-number">1.3.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#REPL环境"><span class="toc-number">1.4.</span> <span class="toc-text">REPL环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步操作"><span class="toc-number">1.5.</span> <span class="toc-text">异步操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全局对象和全局变量"><span class="toc-number">1.6.</span> <span class="toc-text">全局对象和全局变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模块化结构"><span class="toc-number">2.</span> <span class="toc-text">模块化结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#核心模块"><span class="toc-number">2.2.</span> <span class="toc-text">核心模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义模块"><span class="toc-number">2.3.</span> <span class="toc-text">自定义模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http模块"><span class="toc-number">3.</span> <span class="toc-text">http模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本用法-1"><span class="toc-number">3.1.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理POST请求"><span class="toc-number">3.2.</span> <span class="toc-text">处理POST请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发出请求：request方法"><span class="toc-number">3.3.</span> <span class="toc-text">发出请求：request方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搭建HTTPs服务器"><span class="toc-number">3.4.</span> <span class="toc-text">搭建HTTPs服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer对象"><span class="toc-number">4.</span> <span class="toc-text">Buffer对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cluster模块"><span class="toc-number">5.</span> <span class="toc-text">cluster模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异常处理"><span class="toc-number">6.</span> <span class="toc-text">异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#try…catch结构"><span class="toc-number">6.1.</span> <span class="toc-text">try…catch结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uncaughtException事件"><span class="toc-number">6.2.</span> <span class="toc-text">uncaughtException事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正确的编码习惯"><span class="toc-number">6.3.</span> <span class="toc-text">正确的编码习惯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#命令行脚本"><span class="toc-number">7.</span> <span class="toc-text">命令行脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#转载"><span class="toc-number">8.</span> <span class="toc-text">转载</span></a></li></ol>
		</div>
		
		<h2 id="简介">简介</h2>
<p>Node.js是JavaScript在服务器端的一个运行环境，也是一个工具库，用来与服务器端其他软件互动。它的JavaScript解释器，采用了Google公司的V8引擎。</p>
<h3 id="安装与更新">安装与更新</h3>
<p>访问官方网站<a href="http://nodejs.org" target="_blank" rel="external">nodejs.org</a>了解安装细节。</p>
<p>安装完成以后，运行下面的命令，查看是否能正常运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">node --version</div><div class="line">// 或者</div><div class="line">node -v</div></pre></td></tr></table></figure>

<p>更新node.js版本，可以通过node.js的n模块完成。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">sudo</span> npm install n -g</div><div class="line"><span class="built_in">sudo</span> n stable</div></pre></td></tr></table></figure>

<p>上面代码通过n模块，将node.js更新为最新发布的稳定版。</p>
<p>n模块也可以指定安装的版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">sudo</span> n <span class="number">0.8</span>.<span class="number">21</span></div></pre></td></tr></table></figure>

<h3 id="版本管理工具nvm">版本管理工具nvm</h3>
<p>如果想在同一台机器，同时运行多个版本的node.js，就需要用到版本管理工具nvm。</p>
<p>首先，需要安装nvm。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">git clone https://github.com/creationix/nvm.git ~/.nvm</div></pre></td></tr></table></figure>

<p>然后使用下面的命令，激活nvm。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">source</span> ~/.nvm/nvm.sh</div></pre></td></tr></table></figure>

<p>上面这条命令，每次使用nvm前都要输入，建议将其加入~/.bashrc文件（假定你所使用的shell是bash）。</p>
<p>激活nvm之后，就可以安装指定版本的node.js。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvm install <span class="number">0.10</span></div></pre></td></tr></table></figure>

<p>上面这条命令，安装最新的v0.10.x版本的node.js。</p>
<p>安装后，就可以指定使用该版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvm use <span class="number">0.10</span></div></pre></td></tr></table></figure>

<p>或者，直接进入该版本的REPL环境。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvm run <span class="number">0.10</span></div></pre></td></tr></table></figure>

<p>如果在项目根目录下新建一个.nvmrc文件，将版本号写入其中，则nvm use命令就不再需要附加版本号。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvm use</div></pre></td></tr></table></figure>

<p>ls命令用于查看本地所安装的版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvm ls</div></pre></td></tr></table></figure>

<p>ls-remote命令用于查看服务器上所有可供安装的版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvm ls-remote</div></pre></td></tr></table></figure>

<p>如果要退出已经激活的nvm，使用deactivate命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvm deactivate</div></pre></td></tr></table></figure>

<h3 id="基本用法">基本用法</h3>
<p>安装完成后，运行node.js程序，就是使用node命令读取JavaScript脚本。</p>
<p>假定当前目录有一个demo.js的脚本文件，运行时这样写。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">node demo</div><div class="line"></div><div class="line">// 或者</div><div class="line"></div><div class="line">node demo.js</div></pre></td></tr></table></figure>

<h3 id="REPL环境">REPL环境</h3>
<p>在命令行键入node命令，后面没有文件名，就进入一个Node.js的REPL环境（Read–eval–print loop，”读取-求值-输出”循环），可以直接运行各种JavaScript命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">node</div><div class="line">&gt; <span class="number">1</span>+<span class="number">1</span></div><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure>

<p>如果使用参数 —use_strict，则REPL将在严格模式下运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">node --use_strict</div></pre></td></tr></table></figure>

<p>这个REPL是Node.js与用户互动的shell，各种基本的shell功能都可以在里面使用，比如使用上下方向键遍历曾经使用过的命令。特殊变量下划线（_）表示上一个命令的返回结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&gt; <span class="number">1</span>+<span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line">&gt; _+<span class="number">1</span></div><div class="line"><span class="number">3</span></div></pre></td></tr></table></figure>

<p>在REPL中，如果运行一个表达式，会直接在命令行返回结果，如果运行一条语句则不会，因为它没有返回值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&gt; x = <span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line">&gt; var x = <span class="number">1</span></div></pre></td></tr></table></figure>

<p>上面代码的第二条命令，没有显示任何结果。因为这是一条语句，不是表达式，所以没有返回值。</p>
<h3 id="异步操作">异步操作</h3>
<p>Node采用V8引擎处理JavaScript脚本，最大特点就是单线程运行，一次只能运行一个任务。这导致Node大量采用异步操作（asynchronous opertion），即任务不是马上执行，而是插在任务队列的尾部，等到前面的任务运行完后再执行。</p>
<p>由于这种特性，某一个任务的后续操作，往往采用回调函数（callback）的形式进行定义。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> isTrue = <span class="function"><span class="keyword">function</span><span class="params">(value, callback)</span> </span>{</div><div class="line">  <span class="keyword">if</span> (value === <span class="literal">true</span>) {</div><div class="line">    callback(<span class="literal">null</span>, <span class="string">"Value was true."</span>);</div><div class="line">  }</div><div class="line">  <span class="keyword">else</span> {</div><div class="line">    callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Value is not true!"</span>));</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>上面代码就把进一步的处理，交给回调函数callback。约定俗成，callback的位置总是最后一个参数。值得注意的是，callback的格式也有约定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span> <span class="params">(error, value)</span> </span>{</div><div class="line">  <span class="keyword">if</span> (error) {</div><div class="line">    <span class="keyword">return</span> <span class="built_in">console</span>.log(error);</div><div class="line">  }</div><div class="line">  <span class="built_in">console</span>.log(value);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>callback的第一个参数是一个Error对象，第二个参数才是真正的数据。如果没有发生错误，第一个参数就传入null。这种写法有一个很大的好处，就是说只要判断回调函数的第一个参数，就知道有没有出错，如果不是null，就肯定出错了。</p>
<h3 id="全局对象和全局变量">全局对象和全局变量</h3>
<p>Node提供以下一些全局对象，它们是所有模块都可以调用的。</p>
<ul>
<li><strong>global</strong>：表示Node所在的全局环境，类似于浏览器中的window对象。</li>
<li><strong>process</strong>：指向Node内置的process模块，允许开发者与当前进程互动。</li>
<li><strong>console</strong>：指向Node内置的console模块，提供命令行环境中的标准输入、标准输出功能。</li>
</ul>
<p>全局函数：</p>
<ul>
<li><strong>定时器函数</strong>：共有4个，分别是setTimeout(), clearTimeout(), setInterval(), clearInterval()。</li>
<li><strong>require</strong>：用于加载模块。</li>
</ul>
<p>全局变量：</p>
<ul>
<li><strong>_filename</strong>：指向当前运行的脚本文件名。</li>
<li><strong>_dirname</strong>：指向当前运行的脚本所在的目录。</li>
</ul>
<p>除此之外，还有一些对象实际上是模块内部的局部变量，指向的对象根据模块不同而不同，但是所有模块都适用，可以看作是伪全局变量，主要为module, module.exports, exports等。</p>
<p>module变量指代当前模块。module.exports变量表示当前模块对外输出的接口，其他文件加载该模块，实际上就是读取module.exports变量。</p>
<ul>
<li>module.id 模块的识别符，通常是模块的文件名。</li>
<li>module.filename 模块的文件名。</li>
<li>module.loaded 返回一个布尔值，表示模块是否已经完成加载。</li>
<li>module.parent 返回使用该模块的模块。</li>
<li>module.children 返回一个数组，表示该模块要用到的其他模块。</li>
</ul>
<p>这里需要特别指出的是，exports变量实际上是一个指向module.exports对象的链接，等同在每个模块头部，有一行这样的命令。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> exports = <span class="built_in">module</span>.exports;</div></pre></td></tr></table></figure>

<p>这造成的结果是，在对外输出模块接口时，可以向exports对象添加方法，但是不能直接将exports变量指向一个函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">exports = <span class="function"><span class="keyword">function</span> <span class="params">(x)</span></span>{ <span class="built_in">console</span>.log(x);};</div></pre></td></tr></table></figure>

<p>上面这样的写法是无效的，因为它切断了exports与module.exports之间的链接。但是，下面这样写是可以的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">exports.area = <span class="function"><span class="keyword">function</span> <span class="params">(r)</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.PI * r * r;</div><div class="line">};</div><div class="line"></div><div class="line">exports.circumference = <span class="function"><span class="keyword">function</span> <span class="params">(r)</span> </span>{</div><div class="line">  <span class="keyword">return</span> <span class="number">2</span> * <span class="built_in">Math</span>.PI * r;</div><div class="line">};</div></pre></td></tr></table></figure>

<p>如果你觉得，exports与module.exports之间的区别很难分清，一个简单的处理方法，就是放弃使用exports，只使用module.exports。</p>
<h2 id="模块化结构">模块化结构</h2>
<h3 id="概述">概述</h3>
<p>Node.js采用模块化结构，按照<a href="http://wiki.commonjs.org/wiki/CommonJS" target="_blank" rel="external">CommonJS规范</a>定义和使用模块。模块与文件是一一对应关系，即加载一个模块，实际上就是加载对应的一个模块文件。</p>
<p>require方法用于指定加载模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> circle = <span class="built_in">require</span>(<span class="string">'./circle.js'</span>);</div></pre></td></tr></table></figure>

<p>上面代码表明，从当前目录下的circle.js文件，加载circle模块。因为require方法默认加载的就是js文件，因此可以把js后缀名省略。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> circle = <span class="built_in">require</span>(<span class="string">'./circle'</span>);</div></pre></td></tr></table></figure>

<p>require方法的参数是模块文件的名字。它分成两种情况，第一种情况是参数中含有文件路径（比如上例），这时路径是相对于当前脚本所在的目录，第二种情况是参数中不含有文件路径（比如下例）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> bar = <span class="built_in">require</span>(<span class="string">'bar'</span>);</div></pre></td></tr></table></figure>

<p>如果require方法的参数不带有路径，则node.js依次按照以下顺序，去寻找模块文件。</p>
<p>node.js依次到下面的目录，去寻找bar模块。</p>
<ul>
<li>./node_modules/bar</li>
<li>../node_modules/bar</li>
<li>../../node_modules/bar</li>
<li>/node_modules/bar</li>
</ul>
<p>可以看到，如果没有指明模块所在位置，Node会依次从当前目录向上，一级级在node_modules子目录下寻找模块。如果没有找到该模块，会抛出一个错误。这样做的好处是，不同的项目可以在自己的目录中，安装同一个模块的不同版本，而不会发生版本冲突。</p>
<p>有时候，一个模块本身就是一个目录，目录中包含多个文件。这时候，Node在package.json文件中，寻找main属性所指明的模块入口文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">{</div><div class="line">  <span class="string">"name"</span> : <span class="string">"bar"</span>,</div><div class="line">  <span class="string">"main"</span> : <span class="string">"./lib/bar.js"</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>上面代码中，模块的启动文件为lib子目录下的bar.js。当使用require(‘bar’)命令加载该模块时，实际上加载的是<code>bar/lib/some-library.js</code>文件。下面写法会起到同样效果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> bar = <span class="built_in">require</span>(<span class="string">'bar/lib/bar.js'</span>)</div></pre></td></tr></table></figure>

<p>如果模块目录中没有package.json文件，node.js会尝试在模块目录中寻找index.js或index.node文件进行加载。</p>
<p>模块一旦被加载以后，就会被系统缓存。如果第二次还加载该模块，则会返回缓存中的版本，这意味着模块实际上只会执行一次。如果希望模块执行多次，则可以让模块返回一个函数，然后多次调用该函数。</p>
<h3 id="核心模块">核心模块</h3>
<p>如果只是在服务器运行JavaScript代码，用处并不大，因为服务器脚本语言已经有很多种了。Node.js的用处在于，它本身还提供了一系列功能模块，与操作系统互动。这些核心的功能模块，不用安装就可以使用，下面是它们的清单。</p>
<ul>
<li><strong>http</strong>：提供HTTP服务器功能。</li>
<li><strong>url</strong>：解析URL。</li>
<li><strong>fs</strong>：与文件系统交互。</li>
<li><strong>querystring</strong>：解析URL的查询字符串。</li>
<li><strong>child_process</strong>：新建子进程。</li>
<li><strong>util</strong>：提供一系列实用小工具。</li>
<li><strong>path</strong>：处理文件路径。</li>
<li><strong>crypto</strong>：提供加密和解密功能，基本上是对OpenSSL的包装。</li>
</ul>
<p>除了使用核心模块，还可以使用第三方模块，以及自定义模块。</p>
<h3 id="自定义模块">自定义模块</h3>
<p>Node模块采用CommonJS规范。只要符合这个规范，就可以自定义模块。</p>
<p>下面是一个最简单的模块，假定新建一个foo.js文件，写入以下内容。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// foo.js</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span><span class="params">(x)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(x);</div><div class="line">};</div></pre></td></tr></table></figure>

<p>上面代码就是一个模块，它通过module.exports变量，对外输出一个方法。</p>
<p>这个模块的使用方法如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// index.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> m = <span class="built_in">require</span>(<span class="string">'./foo'</span>);</div><div class="line"></div><div class="line">m(<span class="string">"这是自定义模块"</span>);</div></pre></td></tr></table></figure>

<p>上面代码通过require命令加载模块文件foo.js（后缀名省略），将模块的对外接口输出到变量m，然后调用m。这时，在命令行下运行index.js，屏幕上就会输出“这是自定义模块”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ node index</div><div class="line">这是自定义模块</div></pre></td></tr></table></figure>

<p>module变量是整个模块文件的顶层变量，它的exports属性就是模块向外输出的接口。如果直接输出一个函数（就像上面的foo.js），那么调用模块就是调用一个函数。但是，模块也可以输出一个对象。下面对foo.js进行改写。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// foo.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> out = <span class="keyword">new</span> <span class="built_in">Object</span>();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">p</span><span class="params">(string)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(string);</div><div class="line">}</div><div class="line"></div><div class="line">out.print = p;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = out;</div></pre></td></tr></table></figure>

<p>上面的代码表示模块输出out对象，该对象有一个print属性，指向一个函数。下面是这个模块的使用方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// index.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> m = <span class="built_in">require</span>(<span class="string">'./foo'</span>);</div><div class="line"></div><div class="line">m.print(<span class="string">"这是自定义模块"</span>);</div></pre></td></tr></table></figure>

<p>上面代码表示，由于具体的方法定义在模块的print属性上，所以必须显式调用print属性。</p>
<h2 id="http模块">http模块</h2>
<h3 id="基本用法-1">基本用法</h3>
<p>http模块主要用于搭建HTTP服务。使用Node.js搭建HTTP服务器非常简单。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"></div><div class="line">http.createServer(<span class="function"><span class="keyword">function</span> <span class="params">(request, response)</span></span>{</div><div class="line">  response.writeHead(<span class="number">200</span>, {<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>});</div><div class="line">  response.end(<span class="string">'Hello World\n'</span>);</div><div class="line">}).listen(<span class="number">8080</span>, <span class="string">"127.0.0.1"</span>);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Server running on port 8080.'</span>);</div></pre></td></tr></table></figure>

<p>上面代码第一行<code>var http = require(&quot;http&quot;)</code>，表示加载http模块。然后，调用http模块的createServer方法，创造一个服务器实例，将它赋给变量http。</p>
<p>ceateServer方法接受一个函数作为参数，该函数的request参数是一个对象，表示客户端的HTTP请求；response参数也是一个对象，表示服务器端的HTTP回应。response.writeHead方法表示，服务器端回应一个HTTP头信息；response.end方法表示，服务器端回应的具体内容，以及回应完成后关闭本次对话。最后的listen(8080)表示启动服务器实例，监听本机的8080端口。</p>
<p>将上面这几行代码保存成文件app.js，然后用node调用这个文件，服务器就开始运行了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ node app.js</div></pre></td></tr></table></figure>

<p>这时命令行窗口将显示一行提示“Server running at port 8080.”。打开浏览器，访问<a href="http://localhost:8080，网页显示“Hello" target="_blank" rel="external">http://localhost:8080，网页显示“Hello</a> world!”。</p>
<p>上面的例子是当场生成网页，也可以事前写好网页，存在文件中，然后利用fs模块读取网页文件，将其返回。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line">http.createServer(<span class="function"><span class="keyword">function</span> <span class="params">(request, response)</span></span>{</div><div class="line">  fs.readFile(<span class="string">'data.txt'</span>, <span class="function"><span class="keyword">function</span> <span class="title">readData</span><span class="params">(err, data)</span> </span>{</div><div class="line">    response.writeHead(<span class="number">200</span>, {<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>});</div><div class="line">    response.end(data);</div><div class="line">  });</div><div class="line">}).listen(<span class="number">8080</span>, <span class="string">"127.0.0.1"</span>);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Server running on port 8080.'</span>);</div></pre></td></tr></table></figure>

<p>下面的修改则是根据不同网址的请求，显示不同的内容，已经相当于做出一个网站的雏形了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line"></div><div class="line">http.createServer(<span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line"></div><div class="line">  <span class="comment">// 主页</span></div><div class="line">  <span class="keyword">if</span> (req.url == <span class="string">"/"</span>) {</div><div class="line">    res.writeHead(<span class="number">200</span>, { <span class="string">"Content-Type"</span>: <span class="string">"text/html"</span> });</div><div class="line">    res.end(<span class="string">"Welcome to the homepage!"</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// About页面</span></div><div class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (req.url == <span class="string">"/about"</span>) {</div><div class="line">    res.writeHead(<span class="number">200</span>, { <span class="string">"Content-Type"</span>: <span class="string">"text/html"</span> });</div><div class="line">    res.end(<span class="string">"Welcome to the about page!"</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// 404错误</span></div><div class="line">  <span class="keyword">else</span> {</div><div class="line">    res.writeHead(<span class="number">404</span>, { <span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span> });</div><div class="line">    res.end(<span class="string">"404 error! File not found."</span>);</div><div class="line">  }</div><div class="line"></div><div class="line">}).listen(<span class="number">8080</span>, <span class="string">"localhost"</span>);</div></pre></td></tr></table></figure>

<p>回调函数的req（request）对象，拥有以下属性。</p>
<ul>
<li>url：发出请求的网址。</li>
<li>method：HTTP请求的方法。</li>
<li>headers：HTTP请求的所有HTTP头信息。</li>
</ul>
<h3 id="处理POST请求">处理POST请求</h3>
<p>当客户端采用POST方法发送数据时，服务器端可以对data和end两个事件，设立监听函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"></div><div class="line">http.createServer(<span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{</div><div class="line">  <span class="keyword">var</span> content = <span class="string">""</span>;</div><div class="line"></div><div class="line">  req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(chunk)</span> </span>{</div><div class="line">    content += chunk;</div><div class="line">  });</div><div class="line"></div><div class="line">  req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    res.writeHead(<span class="number">200</span>, {<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>});</div><div class="line">  res.write(<span class="string">"You've sent: "</span> + content);</div><div class="line">    res.end();</div><div class="line">  });</div><div class="line"></div><div class="line">}).listen(<span class="number">8080</span>);</div></pre></td></tr></table></figure>

<p>data事件会在数据接收过程中，每收到一段数据就触发一次，接收到的数据被传入回调函数。end事件则是在所有数据接收完成后触发。</p>
<p>对上面代码稍加修改，就可以做出文件上传的功能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="pi"></span></div><div class="line">"use strict";</div><div class="line"></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> destinationFile, fileSize, uploadedBytes;</div><div class="line"></div><div class="line">http.createServer(<span class="function"><span class="keyword">function</span> <span class="params">(request, response)</span> </span>{</div><div class="line">  response.writeHead(<span class="number">200</span>);</div><div class="line">  destinationFile = fs.createWriteStream(<span class="string">"destination.md"</span>);</div><div class="line">  request.pipe(destinationFile);</div><div class="line">  fileSize = request.headers[<span class="string">'content-length'</span>];</div><div class="line">  uploadedBytes = <span class="number">0</span>;</div><div class="line"></div><div class="line">  request.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(d)</span> </span>{</div><div class="line">    uploadedBytes += d.length;</div><div class="line">    <span class="keyword">var</span> p = (uploadedBytes / fileSize) * <span class="number">100</span>;</div><div class="line">    response.write(<span class="string">"Uploading "</span> + <span class="built_in">parseInt</span>(p, <span class="number">0</span>) + <span class="string">" %\n"</span>);</div><div class="line">  });</div><div class="line"></div><div class="line">  request.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    response.end(<span class="string">"File Upload Complete"</span>);</div><div class="line">  });</div><div class="line">}).listen(<span class="number">3030</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"server started"</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<h3 id="发出请求：request方法">发出请求：request方法</h3>
<p>request方法用于发出HTTP请求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"></div><div class="line"><span class="comment">//The url we want is: 'www.random.org/integers/?num=1&min=1&max=10&col=1&base=10&format=plain&rnd=new'</span></div><div class="line"><span class="keyword">var</span> options = {</div><div class="line">  host: <span class="string">'www.random.org'</span>,</div><div class="line">  path: <span class="string">'/integers/?num=1&min=1&max=10&col=1&base=10&format=plain&rnd=new'</span></div><div class="line">};</div><div class="line"></div><div class="line">callback = <span class="function"><span class="keyword">function</span><span class="params">(response)</span> </span>{</div><div class="line">  <span class="keyword">var</span> str = <span class="string">''</span>;</div><div class="line"></div><div class="line">  <span class="comment">//another chunk of data has been recieved, so append it to `str`</span></div><div class="line">  response.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(chunk)</span> </span>{</div><div class="line">    str += chunk;</div><div class="line">  });</div><div class="line"></div><div class="line">  <span class="comment">//the whole response has been recieved, so we just print it out here</span></div><div class="line">  response.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(str);</div><div class="line">  });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">var</span> req = http.request(options, callback);</div><div class="line"></div><div class="line">req.write(<span class="string">"hello world!"</span>);</div><div class="line">req.end();</div></pre></td></tr></table></figure>

<p>request对象的第一个参数是options对象，用于指定请求的域名和路径，第二个参数是请求完成后的回调函数。</p>
<p>如果使用POST方法发出请求，只需在options对象中设定即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> options = {</div><div class="line">  host: <span class="string">'www.example.com'</span>,</div><div class="line">  path: <span class="string">'/'</span>,</div><div class="line">  port: <span class="string">'80'</span>,</div><div class="line">  method: <span class="string">'POST'</span></div><div class="line">};</div></pre></td></tr></table></figure>

<p>指定HTTP头信息，也是在options对象中设定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> options = {</div><div class="line">  headers: {<span class="string">'custom'</span>: <span class="string">'Custom Header Demo works'</span>}</div><div class="line">};</div></pre></td></tr></table></figure>

<h3 id="搭建HTTPs服务器">搭建HTTPs服务器</h3>
<p>搭建HTTPs服务器需要有SSL证书。对于向公众提供服务的网站，SSL证书需要向证书颁发机构购买；对于自用的网站，可以自制。</p>
<p>自制SSL证书需要OpenSSL，具体命令如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">openssl genrsa -out key.pem</div><div class="line">openssl req -new -key key.pem -out csr.pem</div><div class="line">openssl x509 -req -days <span class="number">9999</span> -in csr.pem -signkey key.pem -out cert.pem</div><div class="line">rm csr.pem</div></pre></td></tr></table></figure>

<p>上面的命令生成两个文件：ert.pem（证书文件）和 key.pem（私钥文件）。有了这两个文件，就可以运行HTTPs服务器了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> options = {</div><div class="line">  key: fs.readFileSync(<span class="string">'key.pem'</span>),</div><div class="line">  cert: fs.readFileSync(<span class="string">'cert.pem'</span>)</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">var</span> a = https.createServer(options, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{</div><div class="line">  res.writeHead(<span class="number">200</span>);</div><div class="line">  res.end(<span class="string">"hello world\n"</span>);</div><div class="line">}).listen(<span class="number">8000</span>);</div></pre></td></tr></table></figure>

<p>上面代码显示，HTTPs服务器与HTTP服务器的最大区别，就是createServer方法多了一个options参数。运行以后，就可以测试是否能够正常访问。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">curl -k https://localhost:<span class="number">8000</span></div></pre></td></tr></table></figure>

<h2 id="Buffer对象">Buffer对象</h2>
<p>Buffer对象是Node.js用来处理二进制数据的一个接口。它是一个构造函数，它的实例代表了V8引擎分配的一段内存。</p>
<p>Buffer对象可以用new命令生成一个实例，它的参数就是存入内存的数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> hello = <span class="keyword">new</span> Buffer(<span class="string">'Hello'</span>);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(hello);</div><div class="line"><span class="comment">// &lt;Buffer 48 65 6c 6c 6f&gt;</span></div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(hello.toString());</div><div class="line"><span class="comment">// "Hello"</span></div></pre></td></tr></table></figure>

<p>上面代码表示，hello是一个Buffer，内容为储存在内存中的五个字符的二进制数据，使用toString方法可以看到对应的字符串。</p>
<p>toString方法可以只返回指定位置内存的内容，它的第二个参数表示起始位置，第三个参数表示终止位置，两者都是从0开始计算。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(<span class="string">'just some data'</span>);</div><div class="line"><span class="built_in">console</span>.log(buf.toString(<span class="string">'ascii'</span>, <span class="number">4</span>, <span class="number">9</span>));</div><div class="line"><span class="comment">// "some"</span></div></pre></td></tr></table></figure>

<p>除了使用字符串参数，生成Buffer实例，还可以使用十六进制数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> hello = <span class="keyword">new</span> Buffer([<span class="number">0x48</span>, <span class="number">0x65</span>, <span class="number">0x6c</span>, <span class="number">0x6c</span>, <span class="number">0x6f</span>]);</div></pre></td></tr></table></figure>

<p>构造函数Buffer的参数，如果是一个数值，就表示所生成的实例占据内存多少个字节。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(<span class="number">5</span>);</div><div class="line">buf.write(<span class="string">'He'</span>);</div><div class="line">buf.write(<span class="string">'l'</span>, <span class="number">2</span>);</div><div class="line">buf.write(<span class="string">'lo'</span>, <span class="number">3</span>);</div><div class="line"><span class="built_in">console</span>.log(buf.toString());</div><div class="line"><span class="comment">// "Hello"</span></div></pre></td></tr></table></figure>

<p>Buffer实例的write方法，可以向所指定的内存写入数据。它的第一个参数是所写入的内容，第二个参数是所写入的起始位置（从0开始）。所以，上面代码最后写入内存的内容是Hello。</p>
<p>Buffer实例的length属性，返回Buffer实例所占据的内存长度。如果想知道一个字符串所占据的字节长度，可以将其传入Buffer.byteLength方法。</p>
<p>Buffer实例的slice方法，返回一个按照指定位置、从原对象切割出来的Buffer实例。它的两个参数分别为切割的起始位置和终止位置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(<span class="string">'just some data'</span>);</div><div class="line"><span class="keyword">var</span> chunk = buf.slice(<span class="number">4</span>, <span class="number">9</span>);</div><div class="line"><span class="built_in">console</span>.log(chunk.toString());</div><div class="line"><span class="comment">// "some"</span></div></pre></td></tr></table></figure>

<h2 id="cluster模块">cluster模块</h2>
<p>Node.js默认单进程运行，对于多核CPU的计算机来说，这样做效率很低，因为只有一个核在运行，其他核都在闲置。cluster模块就是为了解决这个问题而提出的。</p>
<p>cluster模块允许设立一个主进程和若干个worker进程，由主进程监控和协调worker进程的运行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> cluster = <span class="built_in">require</span>(<span class="string">'cluster'</span>);</div><div class="line"><span class="keyword">var</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (cluster.isMaster){</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, n = os.cpus().length; i &lt; n; i += <span class="number">1</span>){</div><div class="line">        cluster.fork();</div><div class="line">    }</div><div class="line">}<span class="keyword">else</span>{</div><div class="line">    http.createServer(<span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>{</div><div class="line">      res.writeHead(<span class="number">200</span>);</div><div class="line">      res.end(<span class="string">"hello world\n"</span>);</div><div class="line">    }).listen(<span class="number">8000</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>上面代码先判断当前进程是否为主进程（cluster.isMaster），如果是的，就按照CPU的核数，新建若干个worker进程；如果不是，说明当前进程是worker进程，则在该进程启动一个服务器程序。</p>
<h2 id="异常处理">异常处理</h2>
<p>Node是单线程运行环境，一旦抛出的异常没有被捕获，就会引起整个进程的崩溃。所以，Node的异常处理对于保证系统的稳定运行非常重要。</p>
<h3 id="try…catch结构">try…catch结构</h3>
<p>最常用的捕获异常的方式，就是使用try…catch结构。但是，这个结构无法捕获异步运行的代码抛出的异常。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">try</span> {</div><div class="line">    process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"error"</span>);</div><div class="line">    });</div><div class="line">} <span class="keyword">catch</span> (err) {</div><div class="line">    <span class="comment">//can not catch it</span></div><div class="line">    <span class="built_in">console</span>.log(err);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">try</span> {</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"error"</span>);</div><div class="line">    },<span class="number">1</span>)</div><div class="line">} <span class="keyword">catch</span> (err) {</div><div class="line">    <span class="comment">//can not catch it</span></div><div class="line">    <span class="built_in">console</span>.log(err);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>上面代码抛出的两个异常，都无法被catch代码块捕获。</p>
<h3 id="uncaughtException事件">uncaughtException事件</h3>
<p>当一个异常未被捕获，就会触发uncaughtException事件，可以对这个事件注册回调函数，从而捕获异常。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">process.on(<span class="string">'uncaughtException'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">'Error caught in uncaughtException event:'</span>, err);</div><div class="line">});</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">try</span> {</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"error"</span>);</div><div class="line">    },<span class="number">1</span>)</div><div class="line">} <span class="keyword">catch</span> (err) {</div><div class="line">    <span class="comment">//can not catch it</span></div><div class="line">    <span class="built_in">console</span>.log(err);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>只要给uncaughtException配置了回调，Node进程不会异常退出，但异常发生的上下文已经丢失，无法给出异常发生的详细信息。而且，异常可能导致Node不能正常进行内存回收，出现内存泄露。所以，当uncaughtException触发后，最好记录错误日志，然后结束Node进程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">process.on(<span class="string">'uncaughtException'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> </span>{</div><div class="line">  logger(err);</div><div class="line">  process.exit(<span class="number">1</span>);</div><div class="line">});</div></pre></td></tr></table></figure>

<h3 id="正确的编码习惯">正确的编码习惯</h3>
<p>由于异步中的异常无法被外部捕获，所以异常应该作为第一个参数传递给回调函数，Node的编码规则就是这么规定的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">fs.readFile(<span class="string">'/t.txt'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, data)</span> </span>{</div><div class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">  <span class="built_in">console</span>.log(data);</div><div class="line">});</div></pre></td></tr></table></figure>

<h2 id="命令行脚本">命令行脚本</h2>
<p>node脚本可以作为命令行脚本使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ node foo.js</div></pre></td></tr></table></figure>

<p>上面代码执行了foo.js脚本文件。</p>
<p>foo.js文件的第一行，如果加入了解释器的位置，就可以将其作为命令行工具直接调用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env node</span></div></pre></td></tr></table></figure>

<p>调用前，需更改文件的执行权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ chmod u+x myscript.js</div><div class="line">$ ./foo.js arg1 arg2 ...</div></pre></td></tr></table></figure>

<p>作为命令行脚本时，<code>console.log</code>用于输出内容到标准输出，<code>process.stdin</code>用于读取标准输入，<code>child_process.exec()</code>用于执行一个shell命令。</p>
<h2 id="转载">转载</h2>
<ul>
<li>阮一峰个人博客, <a href="http://javascript.ruanyifeng.com/nodejs/basic.html" target="_blank" rel="external">What is Node.js?</a></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/nodejs/">nodejs</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/frontend/">frontend</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://elevensky.github.io/2015/02/25/nodejs基础教程/" data-title="Node.js 概述 | 程序员的多肉花园" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/02/25/nodejs中exports和module-exports区别/" title="nodejs中exports和module.exports区别">
  <strong>PREVIOUS:</strong><br/>
  <span>
  nodejs中exports和module.exports区别</span>
</a>
</div>


<div class="next">
<a href="/2015/02/22/你是船长/"  title="你是船长，你必须在黑暗中发出微光！">
 <strong>NEXT:</strong><br/> 
 <span>你是船长，你必须在黑暗中发出微光！
</span>
</a>
</div>

</nav>

	
<section id="comment">
  <h1 class="title">文章评论</h1>
  <div class="ds-thread" data-thread-key="2015/02/25/nodejs基础教程/" data-title="Node.js 概述" data-url="http://elevensky.github.io/2015/02/25/nodejs基础教程/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装与更新"><span class="toc-number">1.1.</span> <span class="toc-text">安装与更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#版本管理工具nvm"><span class="toc-number">1.2.</span> <span class="toc-text">版本管理工具nvm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本用法"><span class="toc-number">1.3.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#REPL环境"><span class="toc-number">1.4.</span> <span class="toc-text">REPL环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步操作"><span class="toc-number">1.5.</span> <span class="toc-text">异步操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全局对象和全局变量"><span class="toc-number">1.6.</span> <span class="toc-text">全局对象和全局变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模块化结构"><span class="toc-number">2.</span> <span class="toc-text">模块化结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#核心模块"><span class="toc-number">2.2.</span> <span class="toc-text">核心模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义模块"><span class="toc-number">2.3.</span> <span class="toc-text">自定义模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http模块"><span class="toc-number">3.</span> <span class="toc-text">http模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本用法-1"><span class="toc-number">3.1.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理POST请求"><span class="toc-number">3.2.</span> <span class="toc-text">处理POST请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发出请求：request方法"><span class="toc-number">3.3.</span> <span class="toc-text">发出请求：request方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搭建HTTPs服务器"><span class="toc-number">3.4.</span> <span class="toc-text">搭建HTTPs服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer对象"><span class="toc-number">4.</span> <span class="toc-text">Buffer对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cluster模块"><span class="toc-number">5.</span> <span class="toc-text">cluster模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异常处理"><span class="toc-number">6.</span> <span class="toc-text">异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#try…catch结构"><span class="toc-number">6.1.</span> <span class="toc-text">try…catch结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uncaughtException事件"><span class="toc-number">6.2.</span> <span class="toc-text">uncaughtException事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正确的编码习惯"><span class="toc-number">6.3.</span> <span class="toc-text">正确的编码习惯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#命令行脚本"><span class="toc-number">7.</span> <span class="toc-text">命令行脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#转载"><span class="toc-number">8.</span> <span class="toc-text">转载</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/frontend/" title="frontend">frontend<sup>1</sup></a></li>
		
			<li><a href="/categories/life/" title="life">life<sup>1</sup></a></li>
		
			<li><a href="/categories/-categories-frontend/" title="前端">前端<sup>2</sup></a></li>
		
			<li><a href="/categories/-categories-duorou/" title="多肉">多肉<sup>1</sup></a></li>
		
			<li><a href="/categories/生活/" title="生活">生活<sup>2</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/gulp/" title="gulp">gulp<sup>1</sup></a></li>
		
			<li><a href="/tags/life/" title="life">life<sup>1</sup></a></li>
		
			<li><a href="/tags/nodejs/" title="nodejs">nodejs<sup>2</sup></a></li>
		
		</ul>
</div>


  
<div class="categorieslist">
  <h3 class="asidetitle">近期文章</h3>
  <ul>
    
      <li>
        <a href="/2015/02/25/你是否强大到不需要信仰/">你是否强大到不需要信仰</a>
      </li>
    
      <li>
        <a href="/2015/02/25/nodejs中exports和module-exports区别/">nodejs中exports和module.exports区别</a>
      </li>
    
      <li>
        <a href="/2015/02/25/nodejs基础教程/">Node.js 概述</a>
      </li>
    
      <li>
        <a href="/2015/02/22/你是船长/">你是船长，你必须在黑暗中发出微光！</a>
      </li>
    
      <li>
        <a href="/2015/02/14/Gulp-任务自动管理工具/">Gulp: 任务自动管理工具</a>
      </li>
    
      <li>
        <a href="/2015/02/13/临沂苍山多肉大棚游/">临沂苍山多肉大棚游</a>
      </li>
    
      <li>
        <a href="/2015/02/11/我的2014/">2014年技术战略</a>
      </li>
    
  </ul>
</div>


  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=0&uid=1722627987&verifier=85fa2548&dpc=1"></iframe>

  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><canvas id="canvas"></canvas>
<div id="footer">
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015
		
		<a href="http://elevensky.github.io" target="_blank" title="elevensky">elevensky</a>
		
		<br />
		<span style="color:#817c7c">My heart is beating just for you</span>
		</p>
</div>
<script>
	window.requestAnimFrame = (function(){
	  return  window.requestAnimationFrame       ||
	          window.webkitRequestAnimationFrame ||
	          window.mozRequestAnimationFrame    ||
	          function( callback ){
	            window.setTimeout(callback, 1000 / 60);
	          };
	})();

	var canvas = document.getElementById('canvas'),
		context = canvas.getContext('2d'),
		width = canvas.width = document.body.offsetWidth,
		height = canvas.height,
		ball = {
			x: 0,
			y: height / 2,
		},
		point = {
			x: 0,
			y: ball.y
		},
		current_point = 0;

	var points = [
			{y:0,x:20},
			{y:0,x:1},
	        {y:3,x:1},
		    {y:-10,x:2},
			{y:10,x:2},
		    {y:-12,x:3},
		    {y:35,x:5},
		    {y:-25,x:4},
		    {y:14,x:3},
		    {y:5,x:2},
			{y:0,x:1},
			{y:0,x:20}
		];
	context.fillStyle = "rgb(31, 31, 31)";
	render();
	function animateTo() {
		function dist(x1,x2,y1,y2) {
			var dx = x1 - x2,
				dy = y1 - y2;
			return {
				d: Math.sqrt(dx*dx + dy*dy),
				dx: dx,
				dy: dy
			};
		}
		var dis = dist(ball.x, point.x+points[current_point].x,ball.y, point.y+points[current_point].y);
		if( dis.d > 1 ) {
			var s = Math.abs(dis.dy) > 13 ? 2 : 1;
			ball.x += -( dis.dx / dis.d )*s;
			ball.y += -( dis.dy / dis.d )*s;
		} else {
			ball.x = point.x+points[current_point].x;
			ball.y = point.y+points[current_point].y;
			point.x += points[current_point].x;
			current_point++;
			if( current_point >= points.length || ball.x > width ) {
				current_point = 0;
				if( ball.x > width ) {
					point.x = ball.x = 0;
				}
			}
		}
	}
	function render() {
		requestAnimFrame(render);
		animateTo();
		context.fillStyle = "rgba(0, 0, 0, .01)";
		context.fillRect(0,0,width,height);
		context.fillStyle = "rgba(255, 0, 0, 1)";
		context.beginPath();
		context.arc(ball.x, ball.y, 1, 0, 2*Math.PI, true);
		context.closePath();
		context.fill();
	}
</script></footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"elevensky"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>



  </body>
</html>
